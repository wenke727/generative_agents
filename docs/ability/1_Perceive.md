# 脚本功能概述

该脚本定义了生成型代理（generative agents）的 "Perceive" 模块，用于代理感知周围环境和事件，并将其存储到记忆中，帮助代理在虚拟世界中做出行为决策。

## 1. 核心类和方法

![image-25670730131722507](.fig/Perceive.asset/perceive.png)

`perceive` 函数是一个感知模块，负责生成代理角色的感知行为，包括空间感知和事件感知，并将新感知到的事件存储到角色的记忆中。主要步骤如下：

### 1.1. 空间感知 (_perceice_space)

空间感知负责识别角色周围的环境，并将其存储到角色的空间记忆树（`s_mem.tree`）中。
- **获取附近的tiles**：根据角色当前所在的tile和角色的视野半径，从迷宫中获取附近的tiles。
- **存储感知空间**：遍历这些tiles，将它们的信息（包括世界、区域、竞技场和游戏对象）存储到角色的空间记忆树中。

### 1.2. 事件感知 (_perceive_events)

事件感知负责识别角色周围发生的事件，并将它们按距离排序后感知最近的事件。
- **获取当前竞技场路径**：从迷宫中获取角色当前所在tile对应的竞技场路径。
- **构建感知事件列表**：遍历附近的tiles，将其中发生的事件添加到感知事件列表中，并记录距离。
- **排序并选择事件**：将事件按距离排序，并根据角色的`注意力带宽`选择最近的事件进行感知。

### 1.3. 存储事件

将感知到的事件存储到角色的记忆中。
- **构建事件描述**：遍历感知到的事件，如果谓词不存在，则默认为“is idle”，并构建事件描述。
- **检查是否为新事件**：检索最近感知的事件（`persona.scratch.retention`），如果当前事件是新的，则将其存储到角色的记忆中。
- **管理关键词和嵌入**：为事件生成关键词和嵌入，并计算事件的重要性评分（`poignancy`）。
- **存储聊天事件**：如果事件是角色的自我对话，则将其存储到角色的聊天记忆中。
- **存储事件到记忆中**：将当前事件及其相关信息（包括时间、描述、关键词、嵌入、重要性评分等）添加到角色的记忆中。

### 1.4. 返回感知事件

函数返回感知到并存储的新事件列表。

通过以上步骤，`perceive` 函数实现了角色对周围环境和事件的感知，并将新感知到的事件存储到角色的记忆系统中。这个过程结合了空间感知和事件感知，并通过关键词和嵌入等信息来丰富角色的记忆。

## 2. 总结

`perceive.py` 脚本定义了生成型代理的感知模块，代理通过该模块感知周围的环境和事件，并将其存储到记忆中。这种感知能力使得代理能够在虚拟世界中更加智能地做出决策和行动。脚本中包括生成事件重要性评分、感知空间和事件的具体实现方法。
