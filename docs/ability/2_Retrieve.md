# 脚本功能概述

该脚本定义了生成型代理（generative agents）的 "Retrieve" 模块，用于从代理的记忆中检索与当前感知到的事件相关的记忆和思考。通过计算事件和思考的相似性和重要性，帮助代理在规划时考虑相关的上下文信息。

## 1. 核心类和方法

| 函数名称       | 实现逻辑                                                     | 适用场景                                                     |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `retrieve`     | 1. 初始化返回字典 `retrieved`。<br> 2. 遍历感知事件：<br> - 记录当前事件到 `retrieved` 字典。<br> - 使用 `.a_mem.retrieve_relevant_events` 检索相关事件。<br> - 使用 `.a_mem.retrieve_relevant_thoughts` 检索相关思考。<br> 3. 返回包含相关事件和思考的字典 `retrieved`。 | 当角色需要基于当前感知到的事件做出快速反应或计划时，提供与当前事件相关的上下文信息。 |
| `new_retrieve` | 1. 初始化返回字典 `retrieved`。<br> 2. 遍历焦点点：<br> - 获取所有节点并按创建时间排序。<br> - 计算各项评分：<br> - 提取**新近性**评分并归一化。<br> - 提取**重要性**评分并归一化。<br> - 提取**相关性**评分并归一化。<br> - 计算综合评分并选择最高评分节点。<br> - 更新节点访问时间。<br> - 存储检索结果到 `retrieved`。<br> 3. 返回包含检索到的节点的字典 `retrieved`。 | 当角色需要进行深度反思或回顾时，基于`焦点`提供更全面的记忆检索结果，<u>适合复杂决策和长远计划的场景</u>。 |

## 检索方式1: key 

<img src=".fig/2_Retrieve.asset/image-25670730234114665.png" alt="image-25670730234114665" style="zoom:23%;" />

## 检索方式2

> 检索功能将代理的当前状态作为输入，返回记忆流的子集，并传递给语言模型。检索功能使用三个主要组件来共同产生有效的结果。

三个主要特征

**1. 近时性（Recency）**

- **定义**：给最近访问过的记忆对象分配更高的分数。
- **示例**：最近或今天早上发生的事件很可能留在代理的注意范围内。
- **实现**：在沙盒游戏中，近时性参数按照指数每小时衰减，衰减因子是0.99。

**2. 重要性（Importance）**

- **定义**：将普通记忆和核心记忆区分开，更重要的记忆对象分配更高的分数。
- **实现**：使用大语言模型输出整数分数，prompt如下：
  
  ```
  在1到10的范围内，1代表很普通(例如，刷牙，整理床铺)和10是非常强烈的(例如，分手，大学录取)，请评估下面这段记忆的强烈程度。
  记忆: 在柳树市场和药房买杂货
  评分: <填入>
  ```
- **说明**：重要性评分是在创建内存对象时生成的。

**3. 相关性（Relevance）**

- **定义**：为与当前情况相关的记忆对象分配更高的分数。
- **示例**：如果查询是一个学生正在与同学讨论化学考试要学什么，那么关于早餐的记忆对象应该具有低相关性，而关于老师和作业的记忆对象应该具有高相关性。
- **实现**：使用语言模型生成每个内存的文本描述的嵌入向量Embedding。然后，计算记忆嵌入向量与查询记忆嵌入向量之间的余弦相似度。

**最终得分的计算**

- 为了计算最终的检索分数，我们通过`最小-最大缩放`将近时性、相关性和重要性分数归一化到[0,1]的范围。
- 检索函数将所有记忆作为三个要素的加权组合进行评分，公式为：

​	$$ \text{最终得分} = \alpha \cdot \text{近时性} + \beta \cdot \text{相关性} + \gamma \cdot \text{重要性} $$

- 在实现中，所有的权重参数 \(\alpha\)、\(\beta\) 和 \(\gamma\) 都被设置为1。
- 然后，符合语言模型上下文窗口的排名最高的记忆被包含在提示符中。（即根据窗口大小计算记忆对象的数量K，然后选择TopK）



通过这种机制，我们可以有效地检索并利用代理的记忆，提升其在不同情境下的反应能力。

![image-25670730233519700](.fig/2_Retrieve.asset/new_retrieve_income.png)

<img src=".fig/Retrieve.asset/new_retrieve_outcome.png" alt="image-25670730132246487" style="zoom:40%;" />

![](https://pic1.zhimg.com/80/v2-94b8a4a48c6ee2f5e0343a057cf60dc4_720w.webp)



## 3. 总结

`retrieve.py` 脚本定义了生成型代理的检索模块，通过感知代理周围的事件，检索与这些事件相关的记忆和思考。它包括计算事件和思考的相似性、重要性和相关性的方法，帮助代理在规划时考虑相关的上下文信息。这种检索能力使得代理能够在虚拟世界中更加智能地做出决策和行动。
